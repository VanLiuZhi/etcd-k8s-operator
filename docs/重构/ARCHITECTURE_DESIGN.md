# ETCD Operator æ–°æ¶æ„è®¾è®¡æ–‡æ¡£

[![æ¶æ„çŠ¶æ€](https://img.shields.io/badge/æ¶æ„çŠ¶æ€-è®¾è®¡ä¸­-yellow.svg)](https://github.com/your-org/etcd-k8s-operator)
[![è®¾è®¡ç‰ˆæœ¬](https://img.shields.io/badge/è®¾è®¡ç‰ˆæœ¬-v2.0-blue.svg)](https://github.com/your-org/etcd-k8s-operator)

> **è®¾è®¡çŠ¶æ€**: ğŸš§ è®¾è®¡ä¸­ | **åˆ›å»ºæ—¶é—´**: 2025-08-05 | **è®¾è®¡è€…**: AI Assistant

## ğŸ“‹ æ¶æ„æ¦‚è¿°

### ğŸ¯ è®¾è®¡ç›®æ ‡
- **æ¸…æ™°çš„åˆ†å±‚æ¶æ„**: èŒè´£åˆ†ç¦»ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- **é«˜å†…èšä½è€¦åˆ**: æ¯å±‚ä¸“æ³¨è‡ªå·±çš„èŒè´£
- **å¯æ‰©å±•æ€§**: æ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•
- **å¯æµ‹è¯•æ€§**: æ¯å±‚éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•

### ğŸ—ï¸ å½“å‰æ¶æ„é—®é¢˜

#### ç°æœ‰æ¶æ„é—®é¢˜åˆ†æ
```
å½“å‰æ¶æ„ (é—®é¢˜é‡é‡):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     EtcdClusterController           â”‚
â”‚  (1000+ è¡Œï¼ŒèŒè´£æ··ä¹±)                â”‚
â”‚                                     â”‚
â”‚  â”œâ”€ èµ„æºåˆ›å»ºé€»è¾‘                     â”‚
â”‚  â”œâ”€ çŠ¶æ€æœºå¤„ç†                       â”‚
â”‚  â”œâ”€ æ‰©ç¼©å®¹é€»è¾‘                       â”‚
â”‚  â”œâ”€ å¥åº·æ£€æŸ¥                         â”‚
â”‚  â”œâ”€ é”™è¯¯å¤„ç†                         â”‚
â”‚  â”œâ”€ etcd å®¢æˆ·ç«¯è°ƒç”¨                  â”‚
â”‚  â””â”€ Kubernetes èµ„æºç®¡ç†             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸»è¦é—®é¢˜**:
- âŒ å•ä¸€æ–‡ä»¶è¿‡å¤§ï¼Œéš¾ä»¥ç»´æŠ¤
- âŒ èŒè´£ä¸æ¸…ï¼Œè¿åå•ä¸€èŒè´£åŸåˆ™
- âŒ éš¾ä»¥å•å…ƒæµ‹è¯•
- âŒ ä»£ç é‡å¤ï¼Œæ‰©ç¼©å®¹é€»è¾‘åˆ†æ•£
- âŒ é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€

## ğŸ›ï¸ æ–°æ¶æ„è®¾è®¡

### ğŸ“ å››å±‚æ¶æ„æ¨¡å‹

```
æ–°æ¶æ„ (æ¸…æ™°åˆ†å±‚):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ§åˆ¶å™¨å±‚ (Controller)        â”‚  â† Kubernetes æ§åˆ¶å™¨é€»è¾‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            æœåŠ¡å±‚ (Service)           â”‚  â† ä¸šåŠ¡é€»è¾‘å’Œç¼–æ’
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            èµ„æºå±‚ (Resource)          â”‚  â† Kubernetes èµ„æºç®¡ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            å®¢æˆ·ç«¯å±‚ (Client)          â”‚  â† å¤–éƒ¨ç³»ç»Ÿäº¤äº’
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ å„å±‚èŒè´£å®šä¹‰

#### 1. æ§åˆ¶å™¨å±‚ (Controller Layer)
**èŒè´£**: Kubernetes æ§åˆ¶å™¨é€»è¾‘ï¼Œäº‹ä»¶å¤„ç†ï¼ŒçŠ¶æ€åè°ƒ

```go
// æ§åˆ¶å™¨å±‚ç»„ä»¶
â”œâ”€â”€ ClusterLifecycleController    // é›†ç¾¤ç”Ÿå‘½å‘¨æœŸæ§åˆ¶å™¨
â”œâ”€â”€ ScalingController            // æ‰©ç¼©å®¹æ§åˆ¶å™¨  
â”œâ”€â”€ HealthController             // å¥åº·æ£€æŸ¥æ§åˆ¶å™¨
â”œâ”€â”€ RecoveryController           // æ•…éšœæ¢å¤æ§åˆ¶å™¨
â””â”€â”€ BackupController             // å¤‡ä»½æ¢å¤æ§åˆ¶å™¨
```

**ç‰¹ç‚¹**:
- ğŸ¯ **å•ä¸€èŒè´£**: æ¯ä¸ªæ§åˆ¶å™¨ä¸“æ³¨ç‰¹å®šåŠŸèƒ½
- ğŸ”„ **äº‹ä»¶é©±åŠ¨**: å“åº” Kubernetes äº‹ä»¶
- ğŸ“Š **çŠ¶æ€åè°ƒ**: åè°ƒæœŸæœ›çŠ¶æ€å’Œå®é™…çŠ¶æ€
- ğŸš« **æ— ä¸šåŠ¡é€»è¾‘**: ä¸åŒ…å«å¤æ‚ä¸šåŠ¡é€»è¾‘

#### 2. æœåŠ¡å±‚ (Service Layer)
**èŒè´£**: ä¸šåŠ¡é€»è¾‘å®ç°ï¼Œæµç¨‹ç¼–æ’ï¼Œå†³ç­–åˆ¶å®š

```go
// æœåŠ¡å±‚ç»„ä»¶
â”œâ”€â”€ ClusterService              // é›†ç¾¤ç®¡ç†æœåŠ¡
â”œâ”€â”€ ScalingService             // æ‰©ç¼©å®¹æœåŠ¡
â”œâ”€â”€ HealthService              // å¥åº·æ£€æŸ¥æœåŠ¡
â”œâ”€â”€ BackupService              // å¤‡ä»½æ¢å¤æœåŠ¡
â”œâ”€â”€ SecurityService            // å®‰å…¨ç®¡ç†æœåŠ¡
â””â”€â”€ MonitoringService          // ç›‘æ§æœåŠ¡
```

**ç‰¹ç‚¹**:
- ğŸ§  **ä¸šåŠ¡é€»è¾‘**: åŒ…å«æ‰€æœ‰ä¸šåŠ¡è§„åˆ™å’Œé€»è¾‘
- ğŸ”€ **æµç¨‹ç¼–æ’**: åè°ƒå¤šä¸ªèµ„æºæ“ä½œ
- ğŸ¯ **å†³ç­–åˆ¶å®š**: æ ¹æ®çŠ¶æ€åšå‡ºæ“ä½œå†³ç­–
- ğŸ§ª **æ˜“äºæµ‹è¯•**: çº¯ä¸šåŠ¡é€»è¾‘ï¼Œæ˜“äºå•å…ƒæµ‹è¯•

#### 3. èµ„æºå±‚ (Resource Layer)
**èŒè´£**: Kubernetes èµ„æºçš„ CRUD æ“ä½œï¼Œèµ„æºæ¨¡æ¿ç®¡ç†

```go
// èµ„æºå±‚ç»„ä»¶
â”œâ”€â”€ StatefulSetManager         // StatefulSet ç®¡ç†å™¨
â”œâ”€â”€ ServiceManager             // Service ç®¡ç†å™¨
â”œâ”€â”€ ConfigMapManager           // ConfigMap ç®¡ç†å™¨
â”œâ”€â”€ SecretManager              // Secret ç®¡ç†å™¨
â”œâ”€â”€ PVCManager                 // PVC ç®¡ç†å™¨
â””â”€â”€ ResourceTemplateManager    // èµ„æºæ¨¡æ¿ç®¡ç†å™¨
```

**ç‰¹ç‚¹**:
- ğŸ”§ **èµ„æºæ“ä½œ**: ä¸“æ³¨ Kubernetes èµ„æº CRUD
- ğŸ“‹ **æ¨¡æ¿ç®¡ç†**: ç®¡ç†èµ„æºåˆ›å»ºæ¨¡æ¿
- ğŸ” **çŠ¶æ€æŸ¥è¯¢**: æä¾›èµ„æºçŠ¶æ€æŸ¥è¯¢æ¥å£
- ğŸ›¡ï¸ **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„èµ„æºæ“ä½œé”™è¯¯å¤„ç†

#### 4. å®¢æˆ·ç«¯å±‚ (Client Layer)
**èŒè´£**: å¤–éƒ¨ç³»ç»Ÿäº¤äº’ï¼Œè¿æ¥ç®¡ç†ï¼Œåè®®é€‚é…

```go
// å®¢æˆ·ç«¯å±‚ç»„ä»¶
â”œâ”€â”€ EtcdClient                 // etcd å®¢æˆ·ç«¯å°è£…
â”œâ”€â”€ KubernetesClient           // Kubernetes å®¢æˆ·ç«¯å°è£…
â”œâ”€â”€ MetricsClient              // ç›‘æ§æŒ‡æ ‡å®¢æˆ·ç«¯
â””â”€â”€ BackupStorageClient        // å¤‡ä»½å­˜å‚¨å®¢æˆ·ç«¯
```

**ç‰¹ç‚¹**:
- ğŸŒ **å¤–éƒ¨äº¤äº’**: ä¸å¤–éƒ¨ç³»ç»Ÿé€šä¿¡
- ğŸ”Œ **è¿æ¥ç®¡ç†**: ç®¡ç†è¿æ¥æ± å’Œé‡è¯•
- ğŸ”„ **åè®®é€‚é…**: é€‚é…ä¸åŒçš„é€šä¿¡åè®®
- ğŸ“Š **æŒ‡æ ‡æ”¶é›†**: æ”¶é›†æ“ä½œæŒ‡æ ‡

## ğŸ”— å±‚é—´äº¤äº’è®¾è®¡

### ğŸ“Š äº¤äº’æµç¨‹å›¾

```mermaid
graph TD
    A[Kubernetes Event] --> B[Controller Layer]
    B --> C[Service Layer]
    C --> D[Resource Layer]
    D --> E[Client Layer]
    
    B1[ClusterLifecycleController] --> C1[ClusterService]
    B2[ScalingController] --> C2[ScalingService]
    B3[HealthController] --> C3[HealthService]
    
    C1 --> D1[StatefulSetManager]
    C1 --> D2[ServiceManager]
    C2 --> D1
    C3 --> E1[EtcdClient]
    
    D1 --> E2[KubernetesClient]
    D2 --> E2
```

### ğŸ”„ å…¸å‹æ“ä½œæµç¨‹

#### é›†ç¾¤åˆ›å»ºæµç¨‹
```
1. ClusterLifecycleController æ¥æ”¶åˆ›å»ºäº‹ä»¶
   â†“
2. è°ƒç”¨ ClusterService.CreateCluster()
   â†“
3. ClusterService ç¼–æ’åˆ›å»ºæµç¨‹:
   - è°ƒç”¨ StatefulSetManager.Create()
   - è°ƒç”¨ ServiceManager.Create()
   - è°ƒç”¨ ConfigMapManager.Create()
   â†“
4. å„ Manager é€šè¿‡ KubernetesClient åˆ›å»ºèµ„æº
   â†“
5. è¿”å›åˆ›å»ºç»“æœç»™æ§åˆ¶å™¨
```

#### æ‰©ç¼©å®¹æµç¨‹
```
1. ScalingController æ£€æµ‹åˆ°è§„æ¨¡å˜åŒ–
   â†“
2. è°ƒç”¨ ScalingService.Scale()
   â†“
3. ScalingService æ‰§è¡Œæ‰©ç¼©å®¹é€»è¾‘:
   - é€šè¿‡ EtcdClient æ£€æŸ¥é›†ç¾¤çŠ¶æ€
   - è°ƒç”¨ StatefulSetManager.Scale()
   - æ›´æ–°é›†ç¾¤æˆå‘˜ä¿¡æ¯
   â†“
4. è¿”å›æ‰©ç¼©å®¹ç»“æœ
```

## ğŸ“¦ åŒ…ç»“æ„è®¾è®¡

### ğŸ—‚ï¸ æ–°çš„ç›®å½•ç»“æ„

```
pkg/
â”œâ”€â”€ controller/                 # æ§åˆ¶å™¨å±‚
â”‚   â”œâ”€â”€ cluster/               # é›†ç¾¤ç”Ÿå‘½å‘¨æœŸæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ scaling/               # æ‰©ç¼©å®¹æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ health/                # å¥åº·æ£€æŸ¥æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ recovery/              # æ•…éšœæ¢å¤æ§åˆ¶å™¨
â”‚   â””â”€â”€ backup/                # å¤‡ä»½æ§åˆ¶å™¨
â”œâ”€â”€ service/                   # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ cluster/               # é›†ç¾¤ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ scaling/               # æ‰©ç¼©å®¹æœåŠ¡
â”‚   â”œâ”€â”€ health/                # å¥åº·æ£€æŸ¥æœåŠ¡
â”‚   â”œâ”€â”€ backup/                # å¤‡ä»½æœåŠ¡
â”‚   â”œâ”€â”€ security/              # å®‰å…¨æœåŠ¡
â”‚   â””â”€â”€ monitoring/            # ç›‘æ§æœåŠ¡
â”œâ”€â”€ resource/                  # èµ„æºå±‚
â”‚   â”œâ”€â”€ statefulset/           # StatefulSet ç®¡ç†å™¨
â”‚   â”œâ”€â”€ service/               # Service ç®¡ç†å™¨
â”‚   â”œâ”€â”€ configmap/             # ConfigMap ç®¡ç†å™¨
â”‚   â”œâ”€â”€ secret/                # Secret ç®¡ç†å™¨
â”‚   â”œâ”€â”€ pvc/                   # PVC ç®¡ç†å™¨
â”‚   â””â”€â”€ template/              # èµ„æºæ¨¡æ¿ç®¡ç†å™¨
â”œâ”€â”€ client/                    # å®¢æˆ·ç«¯å±‚
â”‚   â”œâ”€â”€ etcd/                  # etcd å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ kubernetes/            # Kubernetes å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ metrics/               # ç›‘æ§å®¢æˆ·ç«¯
â”‚   â””â”€â”€ storage/               # å­˜å‚¨å®¢æˆ·ç«¯
â””â”€â”€ common/                    # å…¬å…±ç»„ä»¶
    â”œâ”€â”€ types/                 # å…¬å…±ç±»å‹å®šä¹‰
    â”œâ”€â”€ errors/                # é”™è¯¯å®šä¹‰
    â”œâ”€â”€ utils/                 # å·¥å…·å‡½æ•°
    â””â”€â”€ constants/             # å¸¸é‡å®šä¹‰
```

## ğŸ”Œ æ¥å£è®¾è®¡åŸåˆ™

### ğŸ“‹ æ¥å£å®šä¹‰è§„èŒƒ

#### 1. æœåŠ¡å±‚æ¥å£ç¤ºä¾‹
```go
// ClusterService é›†ç¾¤ç®¡ç†æœåŠ¡æ¥å£
type ClusterService interface {
    CreateCluster(ctx context.Context, cluster *v1alpha1.EtcdCluster) error
    DeleteCluster(ctx context.Context, cluster *v1alpha1.EtcdCluster) error
    UpdateCluster(ctx context.Context, cluster *v1alpha1.EtcdCluster) error
    GetClusterStatus(ctx context.Context, cluster *v1alpha1.EtcdCluster) (*ClusterStatus, error)
}

// ScalingService æ‰©ç¼©å®¹æœåŠ¡æ¥å£
type ScalingService interface {
    ScaleUp(ctx context.Context, cluster *v1alpha1.EtcdCluster, targetSize int32) error
    ScaleDown(ctx context.Context, cluster *v1alpha1.EtcdCluster, targetSize int32) error
    ScaleToZero(ctx context.Context, cluster *v1alpha1.EtcdCluster) error
    RestartFromZero(ctx context.Context, cluster *v1alpha1.EtcdCluster) error
}
```

#### 2. èµ„æºå±‚æ¥å£ç¤ºä¾‹
```go
// StatefulSetManager StatefulSet ç®¡ç†å™¨æ¥å£
type StatefulSetManager interface {
    Create(ctx context.Context, cluster *v1alpha1.EtcdCluster) error
    Update(ctx context.Context, cluster *v1alpha1.EtcdCluster) error
    Delete(ctx context.Context, cluster *v1alpha1.EtcdCluster) error
    Get(ctx context.Context, cluster *v1alpha1.EtcdCluster) (*appsv1.StatefulSet, error)
    Scale(ctx context.Context, cluster *v1alpha1.EtcdCluster, replicas int32) error
}
```

### ğŸ¯ æ¥å£è®¾è®¡åŸåˆ™
- **å•ä¸€èŒè´£**: æ¯ä¸ªæ¥å£ä¸“æ³¨ä¸€ä¸ªé¢†åŸŸ
- **ä¾èµ–å€’ç½®**: é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—
- **æ¥å£éš”ç¦»**: å®¢æˆ·ç«¯ä¸åº”ä¾èµ–ä¸éœ€è¦çš„æ¥å£
- **å¼€é—­åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­

## ğŸ“Š æ¶æ„ä¼˜åŠ¿

### âœ… æ–°æ¶æ„ä¼˜åŠ¿

#### 1. **å¯ç»´æŠ¤æ€§æå‡**
- ğŸ¯ **èŒè´£æ¸…æ™°**: æ¯å±‚ä¸“æ³¨è‡ªå·±çš„èŒè´£
- ğŸ“¦ **æ¨¡å—åŒ–**: åŠŸèƒ½æ¨¡å—åŒ–ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹
- ğŸ”§ **ä½è€¦åˆ**: å±‚é—´é€šè¿‡æ¥å£äº¤äº’ï¼Œé™ä½è€¦åˆåº¦

#### 2. **å¯æµ‹è¯•æ€§æå‡**
- ğŸ§ª **å•å…ƒæµ‹è¯•**: æ¯å±‚å¯ç‹¬ç«‹è¿›è¡Œå•å…ƒæµ‹è¯•
- ğŸ­ **Mock å‹å¥½**: æ¥å£è®¾è®¡ä¾¿äº Mock æµ‹è¯•
- ğŸ“Š **æµ‹è¯•è¦†ç›–**: æ›´å®¹æ˜“è¾¾åˆ°é«˜æµ‹è¯•è¦†ç›–ç‡

#### 3. **å¯æ‰©å±•æ€§æå‡**
- ğŸ”Œ **æ’ä»¶åŒ–**: æ–°åŠŸèƒ½å¯ä»¥ä½œä¸ºæ–°çš„æœåŠ¡æ’å…¥
- ğŸ”„ **æ¥å£ç¨³å®š**: æ¥å£ç¨³å®šï¼Œå®ç°å¯ä»¥çµæ´»å˜æ›´
- ğŸ“ˆ **æ°´å¹³æ‰©å±•**: æ”¯æŒåŠŸèƒ½çš„æ°´å¹³æ‰©å±•

#### 4. **æ€§èƒ½æå‡**
- âš¡ **ä¸“é—¨ä¼˜åŒ–**: æ¯å±‚å¯ä»¥é’ˆå¯¹æ€§ä¼˜åŒ–
- ğŸ”„ **å¹¶å‘å‹å¥½**: æ›´å¥½çš„å¹¶å‘å¤„ç†èƒ½åŠ›
- ğŸ“Š **ç›‘æ§å‹å¥½**: æ›´å®¹æ˜“æ·»åŠ ç›‘æ§å’ŒæŒ‡æ ‡

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ğŸ“‹ å®æ–½è®¡åˆ’
1. **æ¥å£å®šä¹‰** - å®šä¹‰å„å±‚è¯¦ç»†æ¥å£
2. **æ ¸å¿ƒå®ç°** - å®ç°æ ¸å¿ƒæœåŠ¡å’Œç®¡ç†å™¨
3. **æ¸è¿›è¿ç§»** - é€æ­¥è¿ç§»ç°æœ‰åŠŸèƒ½
4. **æµ‹è¯•éªŒè¯** - å…¨é¢æµ‹è¯•æ–°æ¶æ„

### ğŸ¯ æˆåŠŸæ ‡å‡†
- âœ… ä»£ç è¡Œæ•°å‡å°‘ 30% ä»¥ä¸Š
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ç‡è¾¾åˆ° 80% ä»¥ä¸Š
- âœ… æ„å»ºæ—¶é—´å‡å°‘ 50%
- âœ… æ‰©ç¼©å®¹åŠŸèƒ½ç¨³å®šæ€§æå‡

---

**ä¸‹ä¸€æ­¥**: å¼€å§‹è¯¦ç»†çš„æ¥å£å®šä¹‰æ–‡æ¡£ç¼–å†™
