# ETCD Operator å½“å‰æµ‹è¯•ç°çŠ¶åˆ†ææŠ¥å‘Š

[![åˆ†æçŠ¶æ€](https://img.shields.io/badge/åˆ†æçŠ¶æ€-å®Œæˆ-green.svg)](https://github.com/your-org/etcd-k8s-operator)
[![é—®é¢˜ç­‰çº§](https://img.shields.io/badge/é—®é¢˜ç­‰çº§-ä¸¥é‡-red.svg)](https://github.com/your-org/etcd-k8s-operator)

> **åˆ†ææ—¶é—´**: 2025-08-05 | **åˆ†æè€…**: AI Assistant | **åŸºäº**: å®é™…ä»£ç å®¡æŸ¥

## ğŸ“Š æµ‹è¯•ç°çŠ¶æ¦‚è§ˆ

### ğŸ¯ æ€»ä½“è¯„ä¼°

| æµ‹è¯•ç±»å‹ | å½“å‰çŠ¶æ€ | é—®é¢˜ç­‰çº§ | è¦†ç›–ç‡ | ç»´æŠ¤æ€§ |
|---------|---------|---------|--------|--------|
| å•å…ƒæµ‹è¯• | âŒ ç¼ºå¤± | ğŸ”´ ä¸¥é‡ | 0% | N/A |
| é›†æˆæµ‹è¯• | âš ï¸ é”™ä½ | ğŸŸ¡ ä¸­ç­‰ | 30% | ğŸ”´ å·® |
| E2Eæµ‹è¯• | âš ï¸ ä¸å®Œæ•´ | ğŸŸ¡ ä¸­ç­‰ | 20% | ğŸ”´ å·® |
| Shellæµ‹è¯• | âœ… åŠŸèƒ½å®Œæ•´ | ğŸŸ¡ ä¸­ç­‰ | 60% | ğŸ”´ å·® |

### ğŸ“ˆ é—®é¢˜ä¸¥é‡ç¨‹åº¦åˆ†å¸ƒ

```
ğŸ”´ ä¸¥é‡é—®é¢˜ (60%):
â”œâ”€â”€ ç¼ºä¹çœŸæ­£çš„å•å…ƒæµ‹è¯•
â”œâ”€â”€ æµ‹è¯•åˆ†å±‚æ··ä¹±
â”œâ”€â”€ Shellè„šæœ¬ä¸Goæµ‹è¯•æ··ç”¨
â””â”€â”€ æµ‹è¯•ç»´æŠ¤æˆæœ¬é«˜

ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (30%):
â”œâ”€â”€ é›†æˆæµ‹è¯•å®é™…æ˜¯å•å…ƒæµ‹è¯•
â”œâ”€â”€ E2Eæµ‹è¯•è¦†ç›–ä¸å…¨
â””â”€â”€ æµ‹è¯•æ•°æ®ç®¡ç†æ··ä¹±

ğŸŸ¢ è½»å¾®é—®é¢˜ (10%):
â”œâ”€â”€ æµ‹è¯•å‘½åä¸è§„èŒƒ
â””â”€â”€ ç¼ºä¹æµ‹è¯•æ–‡æ¡£
```

## ğŸ” è¯¦ç»†é—®é¢˜åˆ†æ

### 1. **å•å…ƒæµ‹è¯•å±‚ - å®Œå…¨ç¼ºå¤±** ğŸ”´

#### å½“å‰çŠ¶å†µ
```
âŒ æ²¡æœ‰çœŸæ­£çš„å•å…ƒæµ‹è¯•
âŒ æ²¡æœ‰Mockå¯¹è±¡
âŒ æ²¡æœ‰éš”ç¦»çš„ç»„ä»¶æµ‹è¯•
âŒ æ— æ³•å¿«é€Ÿåé¦ˆä»£ç è´¨é‡
```

#### å½±å“åˆ†æ
- **å¼€å‘æ•ˆç‡**: æ— æ³•å¿«é€ŸéªŒè¯ä»£ç é€»è¾‘
- **é‡æ„é£é™©**: ç¼ºä¹å®‰å…¨ç½‘ï¼Œé‡æ„å®¹æ˜“å¼•å…¥bug
- **ä»£ç è´¨é‡**: æ— æ³•ä¿è¯å•ä¸ªç»„ä»¶çš„æ­£ç¡®æ€§
- **è°ƒè¯•å›°éš¾**: é—®é¢˜å®šä½éœ€è¦è¿è¡Œå®Œæ•´æµ‹è¯•

#### æ ¹æœ¬åŸå› 
- æ§åˆ¶å™¨ä»£ç è¿‡äºåºå¤§ï¼Œéš¾ä»¥è¿›è¡Œå•å…ƒæµ‹è¯•
- ç¼ºä¹åˆ†å±‚æ¶æ„ï¼Œç»„ä»¶é—´è€¦åˆåº¦é«˜
- æ²¡æœ‰æ¥å£æŠ½è±¡ï¼Œæ— æ³•è¿›è¡ŒMockæµ‹è¯•

### 2. **é›†æˆæµ‹è¯•å±‚ - å®šä½é”™è¯¯** âš ï¸

#### å½“å‰å®ç°åˆ†æ
<augment_code_snippet path="test/integration/etcdcluster_test.go" mode="EXCERPT">
```go
// è¿™å®é™…ä¸Šæ˜¯æ§åˆ¶å™¨æµ‹è¯•ï¼Œä¸æ˜¯çœŸæ­£çš„é›†æˆæµ‹è¯•
It("Should create the necessary resources", func() {
    // åªæµ‹è¯•Kubernetesèµ„æºåˆ›å»º
    Expect(k8sClient.Create(ctx, cluster)).Should(Succeed())
    
    // éªŒè¯StatefulSetåˆ›å»º
    Eventually(func() bool {
        err := k8sClient.Get(ctx, types.NamespacedName{
            Name: cluster.Name, Namespace: cluster.Namespace,
        }, sts)
        return err == nil
    }, time.Minute, time.Second).Should(BeTrue())
})
```
</augment_code_snippet>

#### é—®é¢˜è¯†åˆ«
```
âŒ ä½¿ç”¨envtestæ¨¡æ‹Ÿç¯å¢ƒï¼Œä¸æ˜¯çœŸå®é›†æˆ
âŒ åªæµ‹è¯•Kubernetesèµ„æºï¼Œæ²¡æœ‰æµ‹è¯•etcdåŠŸèƒ½
âŒ ç¼ºä¹ç»„ä»¶é—´çš„çœŸå®äº¤äº’æµ‹è¯•
âŒ æ²¡æœ‰éªŒè¯ä¸šåŠ¡é€»è¾‘çš„æ­£ç¡®æ€§
```

#### åº”è¯¥æ˜¯ä»€ä¹ˆ
```
âœ… ä½¿ç”¨çœŸå®çš„etcdå®¹å™¨
âœ… æµ‹è¯•æ§åˆ¶å™¨ä¸etcdçš„äº¤äº’
âœ… éªŒè¯æ•°æ®æŒä¹…åŒ–å’Œä¸€è‡´æ€§
âœ… æµ‹è¯•æ•…éšœåœºæ™¯å’Œæ¢å¤
```

### 3. **E2Eæµ‹è¯•å±‚ - è¦†ç›–ä¸è¶³** âš ï¸

#### å½“å‰å®ç°åˆ†æ
<augment_code_snippet path="test/e2e/e2e_test.go" mode="EXCERPT">
```go
// åªæµ‹è¯•Operatoréƒ¨ç½²ï¼Œæ²¡æœ‰æµ‹è¯•å®é™…åŠŸèƒ½
It("should run successfully", func() {
    // åªéªŒè¯æ§åˆ¶å™¨Podè¿è¡Œ
    if string(status) != "Running" {
        return fmt.Errorf("controller pod in %s status", status)
    }
    return nil
})
```
</augment_code_snippet>

#### é—®é¢˜è¯†åˆ«
```
âŒ åªæµ‹è¯•Operatoréƒ¨ç½²ï¼Œä¸æµ‹è¯•etcdé›†ç¾¤åŠŸèƒ½
âŒ æ²¡æœ‰åˆ›å»ºå®é™…çš„EtcdClusterèµ„æº
âŒ ç¼ºä¹æ‰©ç¼©å®¹åŠŸèƒ½æµ‹è¯•
âŒ æ²¡æœ‰æ•…éšœæ¢å¤åœºæ™¯æµ‹è¯•
```

#### ç¼ºå¤±çš„å…³é”®æµ‹è¯•åœºæ™¯
- é›†ç¾¤åˆ›å»ºå’Œåˆ é™¤
- æ‰©ç¼©å®¹æ“ä½œ (1â†’3â†’1â†’0â†’1)
- æ•°æ®æŒä¹…åŒ–éªŒè¯
- æ•…éšœæ¢å¤æµ‹è¯•
- æ€§èƒ½å’Œç¨³å®šæ€§æµ‹è¯•

### 4. **Shellè„šæœ¬æµ‹è¯• - åŠŸèƒ½æœ€å®Œæ•´ä½†ç»´æŠ¤å›°éš¾** âš ï¸

#### å½“å‰å®ç°åˆ†æ
<augment_code_snippet path="test/scripts/test-scale-to-zero-simple.sh" mode="EXCERPT">
```bash
# è¿™ä¸ªShellè„šæœ¬å®é™…ä¸Šå®ç°äº†æœ€å®Œæ•´çš„åŠŸèƒ½æµ‹è¯•
echo "ğŸ¯ æµ‹è¯•1: æ‰©å®¹åˆ°3èŠ‚ç‚¹"
scale_cluster 3
wait_for_pods 3
verify_etcd_health 3

echo "ğŸ¯ æµ‹è¯•3: ç¼©å®¹åˆ°0èŠ‚ç‚¹ (åœæ­¢é›†ç¾¤)"
scale_cluster 0
wait_for_pods 0
```
</augment_code_snippet>

#### ä¼˜ç‚¹åˆ†æ
```
âœ… æµ‹è¯•äº†å®Œæ•´çš„æ‰©ç¼©å®¹æµç¨‹
âœ… éªŒè¯äº†etcdé›†ç¾¤å¥åº·çŠ¶æ€
âœ… åŒ…å«äº†æ•°æ®æŒä¹…åŒ–æµ‹è¯•
âœ… è¦†ç›–äº†å…³é”®çš„ä¸šåŠ¡åœºæ™¯
```

#### é—®é¢˜åˆ†æ
```
âŒ ä¸Goæµ‹è¯•æ¡†æ¶ä¸é›†æˆ
âŒ éš¾ä»¥åœ¨CI/CDä¸­ç®¡ç†
âŒ é”™è¯¯å¤„ç†å’ŒæŠ¥å‘Šä¸æ ‡å‡†
âŒ ç»´æŠ¤æˆæœ¬é«˜ï¼Œè°ƒè¯•å›°éš¾
```

## ğŸ“‹ æµ‹è¯•å·¥å…·ä½¿ç”¨åˆ†æ

### å½“å‰ä½¿ç”¨çš„å·¥å…·

#### 1. **Ginkgo/Gomega** - ä½¿ç”¨æ­£ç¡® âœ…
```go
// åœ¨integrationå’Œe2eæµ‹è¯•ä¸­æ­£ç¡®ä½¿ç”¨äº†BDDæ¡†æ¶
var _ = Describe("EtcdCluster Controller", func() {
    Context("When creating an EtcdCluster", func() {
        It("Should create the necessary resources", func() {
            // æµ‹è¯•é€»è¾‘
        })
    })
})
```

**è¯„ä»·**: å·¥å…·é€‰æ‹©æ­£ç¡®ï¼Œä½†ä½¿ç”¨åœºæ™¯ä¸å½“

#### 2. **Controller-Runtime EnvTest** - ä½¿ç”¨æ­£ç¡®ä½†å®šä½é”™è¯¯ âš ï¸
```go
// æ­£ç¡®è®¾ç½®äº†envtestç¯å¢ƒ
testEnv = &envtest.Environment{
    CRDDirectoryPaths: []string{filepath.Join("..", "..", "config", "crd", "bases")},
    BinaryAssetsDirectory: filepath.Join("..", "..", "bin", "k8s", "1.28.3-linux-amd64"),
}
```

**è¯„ä»·**: å·¥å…·ä½¿ç”¨æ­£ç¡®ï¼Œä½†åº”è¯¥ç”¨äºæ§åˆ¶å™¨å•å…ƒæµ‹è¯•ï¼Œä¸æ˜¯é›†æˆæµ‹è¯•

#### 3. **ç¼ºå¤±çš„å…³é”®å·¥å…·** âŒ
```
âŒ æ²¡æœ‰ä½¿ç”¨testifyè¿›è¡Œæ–­è¨€å’ŒMock
âŒ æ²¡æœ‰ä½¿ç”¨testcontainersè¿›è¡ŒçœŸå®ç¯å¢ƒæµ‹è¯•
âŒ æ²¡æœ‰æµ‹è¯•è¦†ç›–ç‡å·¥å…·
âŒ æ²¡æœ‰æ€§èƒ½æµ‹è¯•å·¥å…·
```

## ğŸ¯ å…·ä½“æ”¹è¿›å»ºè®®

### 1. **ç«‹å³è¡ŒåŠ¨é¡¹** (é«˜ä¼˜å…ˆçº§)

#### å»ºç«‹å•å…ƒæµ‹è¯•åŸºç¡€
```bash
# 1. æ·»åŠ æµ‹è¯•ä¾èµ–
go get github.com/stretchr/testify@latest

# 2. åˆ›å»ºæµ‹è¯•ç›®å½•ç»“æ„
mkdir -p test/unit/{service,resource,client,utils}

# 3. åˆ›å»ºç¬¬ä¸€ä¸ªå•å…ƒæµ‹è¯•
# test/unit/utils/validation_test.go
```

#### é‡æ–°å®šä½ç°æœ‰æµ‹è¯•
```bash
# 1. å°†å½“å‰integrationæµ‹è¯•é‡å‘½åä¸ºcontrolleræµ‹è¯•
mv test/integration test/controller

# 2. åˆ›å»ºçœŸæ­£çš„é›†æˆæµ‹è¯•ç›®å½•
mkdir -p test/integration/{service,resource}
```

### 2. **çŸ­æœŸæ”¹è¿›** (ç¬¬2-3å‘¨)

#### å»ºç«‹çœŸæ­£çš„é›†æˆæµ‹è¯•
```go
// ä½¿ç”¨testcontainersåˆ›å»ºçœŸå®etcdç¯å¢ƒ
func setupEtcdContainer() testcontainers.Container {
    req := testcontainers.ContainerRequest{
        Image: "quay.io/coreos/etcd:v3.5.21",
        ExposedPorts: []string{"2379/tcp"},
        WaitingFor: wait.ForLog("ready to serve client requests"),
    }
    // ...
}
```

#### å®Œå–„E2Eæµ‹è¯•
```go
// åŸºäºKindé›†ç¾¤çš„å®Œæ•´E2Eæµ‹è¯•
It("should support complete etcd cluster lifecycle", func() {
    By("creating etcd cluster")
    // åˆ›å»ºé›†ç¾¤
    
    By("scaling cluster")
    // æµ‹è¯•æ‰©ç¼©å®¹
    
    By("verifying data persistence")
    // éªŒè¯æ•°æ®æŒä¹…åŒ–
})
```

### 3. **é•¿æœŸä¼˜åŒ–** (ç¬¬4å‘¨)

#### è¿ç§»Shellè„šæœ¬åŠŸèƒ½
```go
// å°†Shellè„šæœ¬çš„æ‰©ç¼©å®¹æµ‹è¯•è¿ç§»åˆ°Go
var _ = Describe("Scale to Zero E2E", func() {
    It("should support 1â†’3â†’1â†’0â†’1 cycle", func() {
        // å®ç°å®Œæ•´çš„æ‰©ç¼©å®¹å¾ªç¯æµ‹è¯•
    })
})
```

#### å»ºç«‹æµ‹è¯•åŸºç¡€è®¾æ–½
```yaml
# CI/CDé›†æˆ
name: Test Pipeline
on: [push, pull_request]
jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - run: make test-unit
  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - run: make test-integration
  e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - run: make test-e2e
```

## ğŸ“Š æ”¹è¿›åçš„é¢„æœŸæ•ˆæœ

### æµ‹è¯•è´¨é‡æå‡
```
æ”¹è¿›å‰:
â”œâ”€â”€ å•å…ƒæµ‹è¯•è¦†ç›–ç‡: 0%
â”œâ”€â”€ é›†æˆæµ‹è¯•è¦†ç›–ç‡: 30% (å®é™…æ˜¯æ§åˆ¶å™¨æµ‹è¯•)
â”œâ”€â”€ E2Eæµ‹è¯•è¦†ç›–ç‡: 20% (åªæµ‹è¯•éƒ¨ç½²)
â””â”€â”€ æ€»ä½“æµ‹è¯•å¯é æ€§: ä½

æ”¹è¿›å:
â”œâ”€â”€ å•å…ƒæµ‹è¯•è¦†ç›–ç‡: 90%+
â”œâ”€â”€ é›†æˆæµ‹è¯•è¦†ç›–ç‡: 80%+ (çœŸå®çš„ç»„ä»¶é›†æˆ)
â”œâ”€â”€ E2Eæµ‹è¯•è¦†ç›–ç‡: 70%+ (å®Œæ•´çš„ç”¨æˆ·åœºæ™¯)
â””â”€â”€ æ€»ä½“æµ‹è¯•å¯é æ€§: é«˜
```

### å¼€å‘æ•ˆç‡æå‡
```
æ”¹è¿›å‰:
â”œâ”€â”€ æµ‹è¯•æ‰§è¡Œæ—¶é—´: é•¿ (éœ€è¦å®Œæ•´ç¯å¢ƒ)
â”œâ”€â”€ é—®é¢˜å®šä½: å›°éš¾ (ç¼ºä¹åˆ†å±‚æµ‹è¯•)
â”œâ”€â”€ é‡æ„ä¿¡å¿ƒ: ä½ (ç¼ºä¹æµ‹è¯•ä¿æŠ¤)
â””â”€â”€ ç»´æŠ¤æˆæœ¬: é«˜ (å¤šå¥—æµ‹è¯•ä½“ç³»)

æ”¹è¿›å:
â”œâ”€â”€ æµ‹è¯•æ‰§è¡Œæ—¶é—´: åˆ†å±‚ä¼˜åŒ– (å•å…ƒæµ‹è¯•<1s)
â”œâ”€â”€ é—®é¢˜å®šä½: å¿«é€Ÿ (åˆ†å±‚æµ‹è¯•ç²¾ç¡®å®šä½)
â”œâ”€â”€ é‡æ„ä¿¡å¿ƒ: é«˜ (å®Œæ•´æµ‹è¯•è¦†ç›–)
â””â”€â”€ ç»´æŠ¤æˆæœ¬: ä½ (ç»Ÿä¸€æµ‹è¯•æ¡†æ¶)
```

## ğŸš€ å®æ–½è·¯çº¿å›¾

### ç¬¬2å‘¨: åŸºç¡€å»ºè®¾
- [ ] åˆ›å»ºæµ‹è¯•ç›®å½•ç»“æ„
- [ ] æ·»åŠ æµ‹è¯•å·¥å…·ä¾èµ–
- [ ] å»ºç«‹ç¬¬ä¸€ä¸ªå•å…ƒæµ‹è¯•
- [ ] é‡æ–°å®šä½ç°æœ‰æµ‹è¯•

### ç¬¬3å‘¨: æ ¸å¿ƒå®ç°
- [ ] å®ç°æœåŠ¡å±‚å•å…ƒæµ‹è¯•
- [ ] å»ºç«‹çœŸæ­£çš„é›†æˆæµ‹è¯•
- [ ] å®Œå–„E2Eæµ‹è¯•åœºæ™¯
- [ ] å»ºç«‹æµ‹è¯•åŸºç¡€è®¾æ–½

### ç¬¬4å‘¨: å®Œå–„ä¼˜åŒ–
- [ ] è¿ç§»Shellè„šæœ¬åŠŸèƒ½
- [ ] ä¼˜åŒ–æµ‹è¯•æ€§èƒ½
- [ ] å»ºç«‹CI/CDé›†æˆ
- [ ] å®Œå–„æµ‹è¯•æ–‡æ¡£

---

**ç»“è®º**: å½“å‰æµ‹è¯•ä½“ç³»å­˜åœ¨ä¸¥é‡çš„æ¶æ„é—®é¢˜ï¼Œéœ€è¦ç³»ç»Ÿæ€§é‡æ„ã€‚é€šè¿‡å»ºç«‹æ­£ç¡®çš„ä¸‰å±‚æµ‹è¯•æ¶æ„ï¼Œå¯ä»¥æ˜¾è‘—æå‡ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚
