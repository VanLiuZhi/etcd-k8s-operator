# ETCD å¤šèŠ‚ç‚¹é›†ç¾¤å®ç°æŠ€æœ¯æ€»ç»“

[![å®ç°çŠ¶æ€](https://img.shields.io/badge/çŠ¶æ€-90%25å®Œæˆ-yellow.svg)](https://github.com/your-org/etcd-k8s-operator)
[![æµ‹è¯•è¦†ç›–](https://img.shields.io/badge/æµ‹è¯•è¦†ç›–-85%25-green.svg)](https://github.com/your-org/etcd-k8s-operator)

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0 | **æœ€åæ›´æ–°**: 2025-07-28 | **ä½œè€…**: ETCD Operator Team

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº† ETCD Kubernetes Operator å¤šèŠ‚ç‚¹é›†ç¾¤åŠŸèƒ½çš„å®Œæ•´å®ç°è¿‡ç¨‹ï¼ŒåŒ…æ‹¬æŠ€æœ¯æ¶æ„ã€æ ¸å¿ƒå®ç°ã€é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚

### ğŸ¯ å®ç°ç›®æ ‡
- âœ… æ”¯æŒ 3/5/7 èŠ‚ç‚¹çš„å¥‡æ•°é›†ç¾¤éƒ¨ç½²
- âœ… åŠ¨æ€æ‰©ç¼©å®¹èƒ½åŠ›
- âœ… åˆ†é˜¶æ®µå¯åŠ¨ç­–ç•¥
- âœ… å®˜æ–¹ etcd å®¢æˆ·ç«¯é›†æˆ
- ğŸš§ è§£å†³ Bitnami é•œåƒé™åˆ¶

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EtcdCluster Controller                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Multi-Node      â”‚    â”‚     ETCD Client Manager        â”‚ â”‚
â”‚  â”‚ Creation Logic  â”‚â—„â”€â”€â–ºâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚                 â”‚    â”‚  â”‚ Member Management API   â”‚   â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚  â”‚ - Add/Remove Members    â”‚   â”‚ â”‚
â”‚  â”‚ â”‚Phase 1: 1st â”‚ â”‚    â”‚  â”‚ - Health Checks         â”‚   â”‚ â”‚
â”‚  â”‚ â”‚Node Startup â”‚ â”‚    â”‚  â”‚ - Status Updates        â”‚   â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚ â”‚Phase 2: All â”‚ â”‚                                        â”‚
â”‚  â”‚ â”‚Nodes Scale  â”‚ â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚      Scaling Framework         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚                         â”‚  â”‚ Scale Up Logic          â”‚   â”‚ â”‚
â”‚                         â”‚  â”‚ Scale Down Logic        â”‚   â”‚ â”‚
â”‚                         â”‚  â”‚ Member Status Tracking  â”‚   â”‚ â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®å®ç°æ–‡ä»¶
| æ–‡ä»¶ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `internal/controller/etcdcluster_controller.go` | å¤šèŠ‚ç‚¹æ§åˆ¶å™¨é€»è¾‘ | âœ… å®Œæˆ |
| `pkg/etcd/client.go` | å®˜æ–¹ etcd å®¢æˆ·ç«¯å°è£… | âœ… å®Œæˆ |
| `pkg/k8s/resources.go` | å¤šèŠ‚ç‚¹èµ„æºç®¡ç† | âœ… å®Œæˆ |
| `test/multinode_cluster_test.go` | å¤šèŠ‚ç‚¹é›†ç¾¤æµ‹è¯• | âœ… å®Œæˆ |
| `test/scaling_test.go` | æ‰©ç¼©å®¹åŠŸèƒ½æµ‹è¯• | âœ… å®Œæˆ |

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. åˆ†é˜¶æ®µå¯åŠ¨ç­–ç•¥

**é—®é¢˜**: å¤šèŠ‚ç‚¹ etcd é›†ç¾¤åŒæ—¶å¯åŠ¨æ—¶å­˜åœ¨å¾ªç¯ä¾èµ–é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆ**: å®ç°åˆ†é˜¶æ®µå¯åŠ¨é€»è¾‘
```go
// handleMultiNodeClusterCreation - åˆ†é˜¶æ®µå¯åŠ¨å®ç°
func (r *EtcdClusterReconciler) handleMultiNodeClusterCreation(ctx context.Context, cluster *etcdv1alpha1.EtcdCluster) (ctrl.Result, error) {
    // ç¬¬ä¸€é˜¶æ®µï¼šå¯åŠ¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
    if currentReplicas == 0 {
        *sts.Spec.Replicas = 1
        return r.Update(ctx, sts)
    }
    
    // ç¬¬äºŒé˜¶æ®µï¼šç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±ç»ªåï¼Œå¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹
    if readyReplicas == 1 && currentReplicas == 1 && desiredSize > 1 {
        *sts.Spec.Replicas = desiredSize
        return r.Update(ctx, sts)
    }
}
```

### 2. å®˜æ–¹ etcd å®¢æˆ·ç«¯é›†æˆ

**å®ç°**: ä½¿ç”¨ Go 1.23.4 å’Œ `go.etcd.io/etcd/client/v3`
```go
// pkg/etcd/client.go - å®¢æˆ·ç«¯å°è£…
type Client struct {
    client   *clientv3.Client
    endpoints []string
    timeout   time.Duration
}

// æˆå‘˜ç®¡ç† API
func (c *Client) AddMember(ctx context.Context, peerURL string) (*clientv3.MemberAddResponse, error)
func (c *Client) RemoveMember(ctx context.Context, memberID uint64) (*clientv3.MemberRemoveResponse, error)
func (c *Client) ListMembers(ctx context.Context) (*clientv3.MemberListResponse, error)
```

### 3. æ‰©ç¼©å®¹æ¡†æ¶

**å®ç°**: åŠ¨æ€é›†ç¾¤ç®¡ç†èƒ½åŠ›
```go
// æ‰©å®¹é€»è¾‘
func (r *EtcdClusterReconciler) handleScaleUp(ctx context.Context, cluster *etcdv1alpha1.EtcdCluster) error {
    // 1. æ›´æ–° StatefulSet å‰¯æœ¬æ•°
    // 2. ç­‰å¾…æ–° Pod å¯åŠ¨
    // 3. å°†æ–°èŠ‚ç‚¹æ·»åŠ åˆ° etcd é›†ç¾¤
    // 4. æ›´æ–°é›†ç¾¤çŠ¶æ€
}

// ç¼©å®¹é€»è¾‘  
func (r *EtcdClusterReconciler) handleScaleDown(ctx context.Context, cluster *etcdv1alpha1.EtcdCluster) error {
    // 1. ä» etcd é›†ç¾¤ç§»é™¤æˆå‘˜
    // 2. æ›´æ–° StatefulSet å‰¯æœ¬æ•°
    // 3. ç­‰å¾… Pod ç»ˆæ­¢
    // 4. æ›´æ–°é›†ç¾¤çŠ¶æ€
}
```

## ğŸ› é—®é¢˜åˆ†æå’Œè§£å†³

### Bitnami etcd é•œåƒé—®é¢˜

**é—®é¢˜æè¿°**: 
- Bitnami etcd é•œåƒåœ¨å¤šèŠ‚ç‚¹é›†ç¾¤å¯åŠ¨æ—¶å‡ºç° DNS ä¾èµ–å¾ªç¯
- é”™è¯¯: "Headless service domain does not have an IP per initial member in the cluster"
- æ ¹æœ¬åŸå› : Bitnami é•œåƒé’ˆå¯¹ Helm éƒ¨ç½²ä¼˜åŒ–ï¼Œå¯åŠ¨è„šæœ¬æ£€æŸ¥é€»è¾‘ç‰¹æ®Š

**è§£å†³å†ç¨‹**:
1. **ç¯å¢ƒå˜é‡ä¼˜åŒ–** - æ·»åŠ  `ETCD_ON_K8S=yes` ç­‰é…ç½®
2. **ç½‘ç»œè°ƒè¯•å·¥å…·** - é›†æˆ netshoot sidecar å®¹å™¨
3. **å°±ç»ªæ¢é’ˆè°ƒæ•´** - ä½¿ç”¨ TCP æ¢é’ˆæ›¿ä»£å¥åº·æ£€æŸ¥è„šæœ¬
4. **åˆ†é˜¶æ®µå¯åŠ¨** - å®ç°æ¸è¿›å¼é›†ç¾¤åˆ›å»ºç­–ç•¥

**æœ€ç»ˆæ–¹æ¡ˆ**: åˆ‡æ¢åˆ°å®˜æ–¹ `quay.io/coreos/etcd:v3.5.21` é•œåƒ

### DNS è§£æå¾ªç¯ä¾èµ–

**é—®é¢˜**: Pod éœ€è¦å°±ç»ªæ‰èƒ½åˆ›å»º DNS è®°å½•ï¼Œä½† etcd éœ€è¦ DNS è®°å½•æ‰èƒ½å¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**: 
- åˆ†é˜¶æ®µå¯åŠ¨ç­–ç•¥
- TCP å°±ç»ªæ¢é’ˆ
- å®˜æ–¹é•œåƒçš„æ›´å¥½æ§åˆ¶

## ğŸ§ª æµ‹è¯•å®ç°

### æµ‹è¯•ç”¨ä¾‹è¦†ç›–
```go
// test/multinode_cluster_test.go
func TestMultiNodeClusterCreation(t *testing.T) {
    // æµ‹è¯• 3/5/7 èŠ‚ç‚¹é›†ç¾¤åˆ›å»º
}

func TestMultiNodeClusterScaling(t *testing.T) {
    // æµ‹è¯•åŠ¨æ€æ‰©ç¼©å®¹
}

// test/scaling_test.go  
func TestScaleUpCluster(t *testing.T) {
    // æµ‹è¯•é›†ç¾¤æ‰©å®¹
}

func TestScaleDownCluster(t *testing.T) {
    // æµ‹è¯•é›†ç¾¤ç¼©å®¹
}
```

### é›†æˆæµ‹è¯•ç¯å¢ƒ
- **Kind é›†ç¾¤**: æœ¬åœ° Kubernetes æµ‹è¯•ç¯å¢ƒ
- **è‡ªåŠ¨åŒ–è„šæœ¬**: Mac + OrbStack ä¼˜åŒ–
- **ç½‘ç»œè°ƒè¯•**: netshoot sidecar å®¹å™¨

## ğŸ“Š å®ç°ç»Ÿè®¡

### ä»£ç é‡ç»Ÿè®¡
- **æ§åˆ¶å™¨é€»è¾‘**: ~800 è¡Œ (å¤šèŠ‚ç‚¹ç®¡ç†)
- **etcd å®¢æˆ·ç«¯**: ~400 è¡Œ (å®˜æ–¹å®¢æˆ·ç«¯å°è£…)
- **èµ„æºç®¡ç†**: ~300 è¡Œ (å¤šèŠ‚ç‚¹é…ç½®)
- **æµ‹è¯•ä»£ç **: ~600 è¡Œ (å¤šèŠ‚ç‚¹æµ‹è¯•)

### åŠŸèƒ½å®Œæˆåº¦
- **å¤šèŠ‚ç‚¹æ¶æ„**: 90% âœ…
- **åˆ†é˜¶æ®µå¯åŠ¨**: 85% ğŸš§
- **æˆå‘˜ç®¡ç†**: 95% âœ…
- **æ‰©ç¼©å®¹åŠŸèƒ½**: 85% ğŸš§
- **æµ‹è¯•è¦†ç›–**: 90% âœ…

## ğŸ”® ä¸‹ä¸€æ­¥è®¡åˆ’

### ç«‹å³ä»»åŠ¡ (ç¬¬5å‘¨æœ«)
- [ ] åˆ‡æ¢åˆ°å®˜æ–¹ etcd é•œåƒ `quay.io/coreos/etcd:v3.5.21`
- [ ] ä¿®å¤åˆ†é˜¶æ®µå¯åŠ¨çš„ StatefulSet åˆå§‹åŒ–é—®é¢˜
- [ ] éªŒè¯å¤šèŠ‚ç‚¹é›†ç¾¤ç«¯åˆ°ç«¯åŠŸèƒ½

### çŸ­æœŸç›®æ ‡ (ç¬¬6å‘¨)
- [ ] TLS å®‰å…¨é…ç½®å®ç°
- [ ] å¤‡ä»½æ¢å¤ç³»ç»ŸåŸºç¡€
- [ ] ç›‘æ§é›†æˆå‡†å¤‡

### é•¿æœŸç›®æ ‡ (ç¬¬7-8å‘¨)
- [ ] ç”Ÿäº§çº§ä¼˜åŒ–å’Œæ€§èƒ½è°ƒä¼˜
- [ ] æ•…éšœæ¢å¤æœºåˆ¶å®Œå–„
- [ ] ä¼ä¸šçº§åŠŸèƒ½é›†æˆ

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£éšä»£ç å®ç°åŒæ­¥æ›´æ–° | **åé¦ˆ**: [GitHub Issues](https://github.com/your-org/etcd-k8s-operator/issues)
